<!DOCTYPE html>

<html>
    <head>
        <title>ESP32 Camera QR-Code + face recognition</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    </head>

    <body>
        <script src="./WA.js"></script>
        <div class="container pt-4">
            <h1 class="text-center">ESP32-Cam COVID Check-in</h1>
            Welcome to the covid check-in website of Group 3, Electrical-electronic course, HK211, you can connect to your ESP32-Cam and start creating your check-in facility for cheap!
            
            <div class="vstack gap-3">
                <hr>
                <h2>Enter your server</h2>
                <div class="hstack gap-2">
                <input class="form-control" id="server_id" placeholder="Enter your ESP32-Cam streaming IP address">
                <button class="btn btn-secondary" id="server_change">Change server</button>
                </div>
                <hr>
                <h2 id="recog">Camera</h2>
                <canvas id="canvas"></canvas>
                <div class="hstack gap-2">
                    <input class="form-control" id="name" placeholder="Enter your ID here">
                    <button class="btn btn-primary" id="addFace">Add face</button>
                </div>
                
            </div>
        </div>

        <script>
            const width = 800;
            const height = 600;
            const addFaceBtn = document.getElementById('addFace');
            const changeServerBtn = document.getElementById('server_change');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const name = document.getElementById('name');
            const list_names = [];

            
            canvas.width = width;
            canvas.height = height;


            Module.onRuntimeInitialized = () => {

                let cmnd = null;
                let fetching = false;
                let count_pass = 5;
                let add_face = false;

                let currentInterval = null;

                changeServerBtn.onclick = () => {
                    if (currentInterval) {
                        clearInterval(currentInterval);
                        currentInterval = null;
                    }
                    
                    const img = document.createElement('img');
                    img.crossOrigin = "anonymous";
                    img.src = document.getElementById('server_id').value;


                    img.onload = () => {
                        addFaceBtn.onclick = () => {
                            add_face = true;
                            list_names[name.value] = list_names.length;
                        }
                        const bufPtr = Module.ccall('getPtr', 'number', [], null);
                        
                        
                        async function loop() {
                            ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, width, height);
                            const rawData = ctx.getImageData(0, 0, width, height).data;
                            Module.HEAP8.set(rawData, bufPtr);
                            if (add_face) {
                                Module.ccall('faceDetect', 'number', ['number'], [1]);
                                add_face = false;
                                const dataView = new Uint8ClampedArray(Module.HEAP8.buffer, bufPtr, 4 * width * height);
                                ctx.putImageData(new ImageData(dataView, width, height), 0, 0);
                            }
                            else if (!cmnd) {
                                if (!fetching) {
                                    const output = Module.ccall('readCode', 'string', [], []);
                                    const data_line = output.split('\n')[1].split(' ');
                                    if (data_line[0] === 'Data:' && data_line[1].startsWith("https://kbyt.khambenh.gov.vn/#lichsu_tiemchung/model?id=")) {
                                        const id = data_line[1].split('=')[1];
                                        try {
                                            fetching = true;
                                            const response = await fetch(`https://kbyt.khambenh.gov.vn/api/v1/lichsu_tiemchung/${id}`);
                                            const json = await response.json();
                                            cmnd = json.nguoidan.ma_cong_dan;
                                            fetching = false;
                                        }
                                        catch (e) {
                                            cmnd = null;
                                            fetching = false;
                                        }
                                    }
                                }
                            }
                            else {
                                const resid = Module.ccall('faceDetect', 'number', ['number'], [0]);
                                const dataView = new Uint8ClampedArray(Module.HEAP8.buffer, bufPtr, 4 * width * height);
                                ctx.putImageData(new ImageData(dataView, width, height), 0, 0);
                                reading_qr = false;
                            }
                        }
                        currentInterval = setInterval(loop, 34);
                    }
                    img.onerror = () => alert("Can't connect to server");
                }
                
            }
        </script>

    </body>
</html>